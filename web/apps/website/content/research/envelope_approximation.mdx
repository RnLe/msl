import { Callout } from 'nextra/components'

# Photonic Moiré Cavities: From Maxwell to an Envelope Model

1. **Goal.** Predict where moiré lattices create built-in optical cavities (no hand-placed defects), and estimate their frequencies and spatial profiles without huge supercells.
2. **Ansatz.** Use a two-scale separation: a fast Bloch carrier from one isolated band at a single k-point, modulated by a slow envelope living on the moiré scale.
3. **Tool.** Derive a Schrödinger-like envelope equation with an effective mass tensor and a registry-dependent potential built from local band edges (AA, AB, …).

---

## In a nutshell: What matters

- Pick **one band** at **one k-point** `k0` where the band has an **extremum** (Γ, K, M, …) and is **spectrally isolated** from neighbors.
- Compute (for small registry cells AA, AB, … at the **same band** and **same k0**):
  - the **band-edge** frequencies `ω_edge^registry(k0)`
  - the **effective mass tensor** `M` from the band’s Hessian at `k0`
- Build a **moiré potential**: $V(\mathbf r) = \omega_{\text{edge}}(\text{registry}(\mathbf r)) - \omega_0$, where $\omega_0 = \omega_n(\mathbf k_0)$.
- Solve the **envelope equation** on the moiré cell:
  
  $$
  \Big[-\frac{\hbar^2}{2}\,\nabla\!\cdot\!M^{-1}\nabla + V(\mathbf r)\Big]F(\mathbf r)=\Delta\omega\,F(\mathbf r), \qquad \Delta\omega=\omega-\omega_0.
  $$
  
- Bound states $(\Delta\omega_n, F_n)$ are **cavity candidates**. Validate only top ones with a small full-wave run if needed.

<Callout type="info">
<strong>Why this works.</strong> The moiré period <code>L</code> is much larger than the lattice constant <code>a</code> (let <code>η=a/L≪1</code>), so the field can be written as a fast Bloch factor times a slow envelope. At a band extremum the linear (drift) term vanishes, leaving a quadratic kinetic term with the band curvature (effective mass). The slow registry field supplies the potential.
</Callout>

---

# Theory

## Physical setup and scales

- Periodic baseline permittivity: $\varepsilon_0(\mathbf r)$ (lattice scale $a$).
- Slow (moiré) modulation from bilayer stacking: $\delta\varepsilon(\mathbf r)$ varying on $L \gg a$.
- Small parameter $\eta = a/L \ll 1$. Introduce slow coordinate $\mathbf R=\eta \mathbf r$.

Scalar TE-like eigenproblem in 2D slab form:
$$
\nabla\!\cdot\!\Big(\tfrac{1}{\varepsilon(\mathbf r)}\,\nabla H_z\Big)+\tfrac{\omega^2}{c^2}H_z=0, 
\qquad \varepsilon=\varepsilon_0+\delta\varepsilon .
$$

Bloch solutions of the unmodulated medium:
$$
H_z^{(0)}(\mathbf r)=u_{n,\mathbf k}(\mathbf r)\,e^{i\mathbf k\cdot\mathbf r}, \quad
u_{n,\mathbf k}(\mathbf r+\mathbf a_i)=u_{n,\mathbf k}(\mathbf r).
$$

## Central ansatz (two-scale expansion)

Pick a single band $n$ and a single k-point $\mathbf k_0$ at a band extremum. Seek
$$
H_z(\mathbf r)=F(\mathbf R)\,u_{n,\mathbf k_0}(\mathbf r)\,e^{i\mathbf k_0\cdot\mathbf r}, 
\qquad \mathbf R=\eta\mathbf r, \quad \langle u_{n,\mathbf k_0},u_{n,\mathbf k_0}\rangle_{\text{cell}}=1 .
$$

Gradient splitting (chain rule):
$$
\nabla \;\mapsto\; \nabla_{\mathbf r} + \eta\,\nabla_{\mathbf R}, \qquad
\nabla_{\mathbf r}F=\eta\,\nabla_{\mathbf R}F .
$$

## Operator expansion (structure of terms)

Insert the ansatz in $\nabla\!\cdot\!\big(\varepsilon^{-1}\nabla\cdot \big)$. After product rules you get, schematically:

- **Pure slow:** $\propto \nabla^2 F$ (order $\eta^2$)
- **Cross terms:** $\propto (\nabla F)\cdot(\nabla+i\mathbf k_0)u$ (order $\eta$); two adjoint pieces sum to $2\,\mathrm{Re}\{\cdots\}$
- **Pure fast:** terms with $F$ constant multiplying $(\nabla+i\mathbf k_0)^2 u$ (order 1)

## Projection (cell averaging / Galerkin step)

Project onto $u_{n,\mathbf k_0}$ by cell-averaging over the fast unit cell (periodic inner product). Treat $F$ and $\nabla F$ as constants over that cell.

- The order-$\eta$ cross term is proportional to the group velocity $\mathbf v_g=\nabla_{\mathbf k}\omega_n|_{\mathbf k_0}$ and vanishes at an extremum.
- The order-$\eta^2$ term becomes the kinetic energy with the effective-mass tensor:
  
  $$
  (M^{-1})_{ij}=\hbar^{-2}\,\frac{\partial^2 \omega_n}{\partial k_i\partial k_j}\Big|_{\mathbf k_0}, 
  \qquad \omega_n(\mathbf k)\approx \omega_0+\tfrac{\hbar^2}{2}(\mathbf k-\mathbf k_0)^\top M^{-1}(\mathbf k-\mathbf k_0).
  $$
  
- The slow modulation $\delta\varepsilon(\mathbf r)$ produces a scalar frequency shift.

## Local band-edge mapping (the potential)

Approximate the shift by the local registry band edge at the same band and same $\mathbf k_0$:
$$
V(\mathbf r)=\omega_{\text{edge}}(\text{registry at }\mathbf r)-\omega_0,
$$
where $\omega_{\text{edge}}$ is taken from small registry cells (AA, AB, …). For identical layers, AB and BA are equivalent by symmetry.

## Envelope (effective-mass) equation

Collecting terms yields the scalar eigenproblem for the envelope:
$$
\Big[-\tfrac{\hbar^2}{2}\,\nabla\!\cdot\!M^{-1}\nabla + V(\mathbf r)\Big]F(\mathbf r)
= \Delta\omega\,F(\mathbf r), \qquad \Delta\omega=\omega-\omega_0 .
$$

- Minima of $V$ host bound states $F$ which are moiré cavities.
- Anisotropic $M$ is natural; isotropy is the special case $M=m^* \mathbb I$.

<Callout type="warning">
<strong>Validity conditions.</strong> (i) One isolated band near <code>k0</code> (spectral gaps to neighbors); (ii) <code>k0</code> is a band extremum (no drift term); (iii) slow modulation <code>L ≫ a</code>; (iv) same band index and same <code>k0</code> across registries; (v) weak interband coupling.
</Callout>

---

# Minimal workflow

**Inputs per configuration**
- Band index `n`, k-point `k0`
- Registry cells (AA, AB, …), same `n` and `k0`
- From small cells: `ω_edge^AA`, `ω_edge^AB`, Hessian → `M`

**Build the potential**
$$
V(\mathbf r)=
\begin{cases}
\omega_{\text{edge}}^{\text{AA}}-\omega_0, & \text{AA region},\\[4pt]
\omega_{\text{edge}}^{\text{AB}}-\omega_0, & \text{AB region}.
\end{cases}
$$
(Smooth interpolation optional.)

**Solve the envelope**
- On one moiré cell (periodic BCs) or a local patch (Dirichlet or PML)
- Extract lowest eigenpairs $(\Delta\omega_n, F_n)$
- Compute mode sizes (from the Hessian of $V$ at minima, or from $F$): localization lengths, participation, mode volume

**Design outline**
- **Prefilter metrics (registry stage):** potential contrast $\Delta V=|\omega_{\text{AB}}-\omega_{\text{AA}}|$, isolation gap at `k0`, mass quality (magnitude or isotropy of $M$), light-line margin or symmetry-BIC flag
- **Envelope metrics:** mode volume or participation, in-plane tunneling proxy (WKB along least-action path), predicted frequency $\omega=\omega_0+\Delta\omega$
- **Optional radiation proxy:** guided-mode expansion or symmetry overlap with light-cone channels to estimate a Q-proxy; reserve FDTD for the final short list

---

## Notes and pitfalls

- Same band and same `k0` in all registry cells; do not mix different k-points.
- Effective mass extraction: use small symmetric k-stencils around `k0`; check Hessian symmetry and definiteness.
- Registry equivalence: for identical layers AB and BA are equivalent; otherwise keep both.
- Scale separation: if the twist is too large (small moiré), revisit assumptions; multi-band envelopes may be required near degeneracies.

---

## Quick reference equations

Effective mass tensor:
$$
(M^{-1})_{ij}=\hbar^{-2}\,\partial_{k_i}\partial_{k_j}\omega_n(\mathbf k)\big|_{\mathbf k_0}.
$$

Envelope eigenproblem:
$$
-\tfrac{\hbar^2}{2}\,\nabla\!\cdot M^{-1}\nabla F + V(\mathbf r)F = \Delta\omega\,F.
$$

Harmonic approximation near a minimum $\mathbf r_0$:
$$
V(\mathbf r)\approx V_0+\tfrac12(\mathbf r-\mathbf r_0)^\top K\,(\mathbf r-\mathbf r_0),
$$
which yields Gaussian envelopes and localization lengths set by $M$ and $K$.

<Callout type="tip">
<strong>What can be skipped:</strong> Full supercell bandstructures. The small registry cells plus the envelope solve already predict where cavities form and at what frequencies. Use full-wave only to get <em>Q</em> on the final candidates.
</Callout>